<template lang="pug">
  div.swipe-tab(:class="['theme-' + theme]")
    nav.tab
      ul
        li.tabs(v-for="(t, i) in tabs" :class="{active: current == i}")
          a(@click="tab(i)") {{ t }}
      div.arw-area
        div.arw(:style="{width: arwWidth + 'px', left: arwLeft + 'px'}")

    div.inner(v-smartscroll="")
      div.scrollable(:style="{width: scrollableWidth + 'vw', transform: 'translateX(-' + scrollableX + 'vw)'}")
        div.background(:style="{width: 100 * components.length + 'vw'}")
          div.view(v-for="c in components")
            component(:is="c")
</template>

<script>
export default {
  name: 'swipe-tab',
  props: {
    tabs: {
      type: Array,
      default: []
    },
    components: {
      type: Array,
      default: []
    },
    theme: {
      type: Number,
      default: 1
    }
  },
  data () {
    return {
      elScroll: null,
      elTab: null,
      current: 0,
      tabsInfo: [],
      touchX: 0,
      nowX: 0,
      oldX: 0,
      isTouch: false,
      arwWidth: 0,
      arwLeft: 0,
      scrollableWidth: 0,
      scrollableX: 0
    }
  },
  directives: {
    smartscroll: {
      bind (el, binding, vnode) {
        let c = vnode.context
        c.elScroll = el
        let handleTouchMove = (e) => {
          e.preventDefault()
        }
        el.addEventListener('touchstart', (event) => {
          c.isTouch = true
          c.touchX = event.touches[0].clientX
          window.removeEventListener('touchmove', handleTouchMove, false)
        })
        el.addEventListener('touchend', (event) => {
          c.isTouch = false
          window.addEventListener('touchmove', handleTouchMove, { passive: false })
          // let d = Math.abs(c.oldX - c.nowX)
          // console.log(d)
          let time = 100
          setTimeout(() => {
            if (c.getDistance() > 0.5) {
              c.tab(c.current + 1)
            } else if (c.getDistance() < -0.5) {
              c.tab(c.current - 1)
            } else {
              c.tab(c.current)
            }
          }, time)
        })
        el.addEventListener('scroll', (event) => {
          c.arwAnimation()
          // let oldX = c.nowX
          // let nowX = el.scrollLeft
          /* if (oldX !== nowX) {
            c.oldX = oldX
            c.nowX = nowX
            c.arwAnimation()
          } */
        })
        el.addEventListener('touchmove', (event) => {
          let touchX = event.touches[0].clientX
          el.scrollLeft += (c.touchX - touchX)
          c.touchX = touchX

          let oldX = c.nowX
          let nowX = el.scrollLeft
          if (oldX !== nowX) {
            c.oldX = oldX
            c.nowX = nowX
            if (c.isTouch) {
              if (c.getDistance() > 1) {
                c.scrollableWidth = 100 * (c.current + 2)
                return false
              }
            } else {
              // console.log('warn: old:' + c.oldX + ', new:' + c.nowX)
              // if (c.nowX > 360) {
              //   el.scrollLeft = 360
              //   c.nowX = 360
              // }
              // if (c.nowX <= 0) {
              //   el.scrollLeft = 0
              //   c.nowX = 0
              // }
              // el.scrollLeft = oldX
              // c.nowX = oldX
            }
          }
        })
      }
    }
  },
  mounted () {
    this.elTab = document.getElementsByClassName('tab')[0]
    this.scrollableWidth = 200
    let tabs = document.getElementsByClassName('tabs')
    let elms = []
    let left = 0
    let right = 0
    elms.forEach.call(tabs, (e) => {
      right += e.clientWidth
      let center = left + (e.clientWidth / 2)
      this.tabsInfo.push({
        width: e.clientWidth,
        left: left,
        right: right,
        center: center
      })
      left += e.clientWidth
    })
    this.arwWidth = this.tabsInfo[0].width
    this.arwLeft = this.tabsInfo[0].left
  },
  methods: {
    scroll (num) {
      if (num !== this.components.length - 1) {
        this.scrollableWidth = 100 * (num + 2)
      } else {
        this.scrollableWidth = 100 * (num + 1)
      }
      if (num > 1) {
        this.scrollableX = 100 * (num - 1)
      } else {
        this.scrollableX = 0
      }
      if (num > 0) {
        this.elScroll.scrollLeft = window.innerWidth // * num
      } else {
        this.elScroll.scrollLeft = 0
      }
      this.current = num
    },
    tab (num) {
      this.arwWidth = this.tabsInfo[num].width
      this.arwLeft = this.tabsInfo[num].left
      this.elTab.scrollLeft = this.tabsInfo[num].center - (window.innerWidth / 2)
      this.scroll(num)
    },
    getDistance () {
      let nowScroll = this.elScroll.scrollLeft
      let w = 0
      if (this.scrollableWidth > 200) {
        w = window.innerWidth
      }
      return (nowScroll - w) / window.innerWidth
    },
    getS (input) {
      let nxt = 1
      let distance = this.getDistance()
      if (distance < 0) nxt = -1
      if (this.current + nxt === this.components.length) return this.tabsInfo[this.current][input]
      return this.tabsInfo[this.current][input] + (this.tabsInfo[this.current + nxt][input] - this.tabsInfo[this.current][input]) * distance * nxt
    },
    arwAnimation () {
      this.arwLeft = this.getS('left')
      this.arwWidth = this.getS('width')
      this.elTab.scrollLeft = this.getS('center') - (window.innerWidth / 2)
    }
  }
}
</script>

<style lang="stylus">
.swipe-tab
  position relative
  .tab
    width 100%
    position absolute
    background #fff
    z-index 1
    width 100vw
    overflow-x scroll
    &.flex
      ul
        width 100%
        float none
        padding 0
        display flex
        justify-content space-around
        li
          width 100%
      .arw-area
        top auto
    ul
      margin 0
      padding 0
      list-style none
      width 1000%
      li
        float left
        a
          padding 7px 15px
          box-sizing border-box
          background #000
          color #999
          display block
          width 100%
          text-align center
        &.active
          a
            color #fff
            text-decoration none

    .arw-area
      width 100%
      height 2px
      position relative
      top 36px
      .arw
        transition 0.1s
        display block
        height 2px
        background #f00
        position absolute
        left 0
        bottom 0
  .inner
    width 100vw
    height calc(100vh - 38px)
    padding-top 38px
    overflow-y hidden
    overflow-x hidden
    .scrollable
      width 100vw
      overflow hidden
      &:after
        content: "";
        display: block;
        height: 0;
        clear: both;
        visibility:hidden;
      .view
        width 100vw
        float left
        height calc(100vh - 38px)
        overflow-y scroll
  &.theme-2
    .tab
      ul
        li
          padding 10px 2px
          margin 0
          a
            color #313140
            &:active, &:hover
              text-decoration none
          &.active
            a
              color #fff
      .arw-area
        z-index -1
        top -4px
        .arw
          border-radius 5px
          background #00a2fd
          height 38px
</style>
